<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cube Sudoku Pro - V3.0</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root {
            /* Light Mode */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --primary: #4A90E2;
            --accent: #8b5cf6;
            --grid-line: #cbd5e1;
            --grid-bold: #1e293b;
            --selected: #dbeafe;
            --related: #f1f5f9;
            --same-num: #fef08a;
            --error: #ef4444;
            --fixed: #64748b;
            --note: #94a3b8;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --grid-line: #334155;
            --grid-bold: #f8fafc;
            --selected: #1e40af;
            --related: #1e293b;
            --same-num: #854d0e;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
        }

        /* Header & Stats */
        .top-bar {
            width: 100%; padding: 10px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timer-box { font-variant-numeric: tabular-nums; font-weight: bold; font-size: 1.1rem; }

        /* The Grid */
        #sudoku-grid {
            display: grid; grid-template-columns: repeat(9, 1fr);
            width: 95vw; max-width: 450px; aspect-ratio: 1/1;
            background: var(--grid-line); border: 2px solid var(--grid-bold);
            margin: 10px 0;
        }

        .cell {
            background: var(--surface); display: flex; align-items: center;
            justify-content: center; position: relative; cursor: pointer;
            font-size: 1.5rem; font-weight: 500; transition: background 0.1s;
        }

        /* 3x3 Block Borders */
        .cell:nth-child(3n) { border-left: 2px solid var(--grid-bold); }
        .cell:nth-child(9n) { border-left: none; }
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid-bold); }

        /* Cell States */
        .cell.selected { background: var(--selected) !important; }
        .cell.related { background: var(--related); }
        .cell.same-val { background: var(--same-num); }
        .cell.err { color: var(--error); }
        .cell.is-fixed { color: var(--fixed); font-weight: 800; }

        /* Notes Grid */
        .notes-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            width: 100%; height: 100%; pointer-events: none;
        }
        .note-digit {
            font-size: 0.6rem; color: var(--note);
            display: flex; align-items: center; justify-content: center;
        }

        /* Toolbar & Numpad */
        .toolbar { display: flex; gap: 15px; margin: 5px 0; }
        .tool-btn { 
            background: var(--surface); border: 1px solid var(--grid-line);
            padding: 8px; border-radius: 8px; cursor: pointer; color: var(--text);
            display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;
        }
        .tool-btn.active { background: var(--primary); color: white; }

        .numpad {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 8px; width: 95vw; max-width: 450px; padding: 10px;
        }
        .num-btn {
            background: var(--surface); border: none; border-radius: 12px;
            height: 50px; font-size: 1.4rem; font-weight: bold;
            color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .num-btn:active { transform: scale(0.95); background: var(--primary); color: white; }

        /* Modals */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: var(--surface); padding: 30px; border-radius: 20px;
            width: 80%; max-width: 400px; text-align: center;
        }

        @media (orientation: landscape) {
            body { flex-direction: row; justify-content: space-around; }
            #sudoku-grid { height: 80vh; width: auto; }
        }
    </style>
</head>
<body data-theme="light">

<div class="top-bar">
    <div onclick="toggleSettings()">锔</div>
    <div class="timer-box" id="timer">00:00</div>
    <div id="difficulty-label">MEDIUM</div>
    <div onclick="toggleStats()"></div>
</div>

<div id="sudoku-grid"></div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()"><span>╋</span>Undo</button>
    <button class="tool-btn" id="note-toggle" onclick="toggleNoteMode()"><span>锔</span>Notes</button>
    <button class="tool-btn" onclick="getHint()"><span></span>Hint</button>
    <button class="tool-btn" onclick="eraseCell()"><span>Ч</span>Erase</button>
</div>

<div class="numpad">
    <button class="num-btn" onclick="handleInput(1)">1</button>
    <button class="num-btn" onclick="handleInput(2)">2</button>
    <button class="num-btn" onclick="handleInput(3)">3</button>
    <button class="num-btn" onclick="handleInput(4)">4</button>
    <button class="num-btn" onclick="handleInput(5)">5</button>
    <button class="num-btn" onclick="handleInput(6)">6</button>
    <button class="num-btn" onclick="handleInput(7)">7</button>
    <button class="num-btn" onclick="handleInput(8)">8</button>
    <button class="num-btn" onclick="handleInput(9)">9</button>
    <button class="num-btn" onclick="handleInput(0)" style="font-size:1rem">拽</button>
</div>

<div id="start-modal" class="modal" style="display: flex;">
    <div class="modal-content">
        <img src="logo.png" style="width:80px; margin-bottom:15px;">
        <h2>Cube Sudoku Pro</h2>
        <div id="resume-box" style="display:none">
            <button onclick="resumeGame()" style="width:100%; margin-bottom:10px; background:var(--accent); color:white; padding:15px; border-radius:10px; border:none;">砖 砖拽 专</button>
        </div>
        <p>专 专转 拽砖:</p>
        <div style="display:grid; gap:10px;">
            <button onclick="startNewGame('easy')">拽</button>
            <button onclick="startNewGame('medium')"></button>
            <button onclick="startNewGame('hard')">拽砖</button>
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    let state = {
        board: Array(81).fill(0),
        initial: Array(81).fill(0),
        notes: Array.from({length: 81}, () => []),
        solution: [],
        history: [],
        selected: null,
        noteMode: false,
        time: 0,
        level: 'medium',
        errors: 0,
        settings: { sound: true, vibration: true, theme: 'light', showErrors: true }
    };

    let timerInterval;

    // --- Core Logic: Solver & Generator ---
    const Solver = {
        isValid(board, idx, num) {
            const r = Math.floor(idx / 9), c = idx % 9;
            const bR = Math.floor(r / 3) * 3, bC = Math.floor(c / 3) * 3;
            for (let i = 0; i < 9; i++) {
                if (board[r * 9 + i] === num || board[i * 9 + c] === num) return false;
                let bIdx = (bR + Math.floor(i / 3)) * 9 + (bC + i % 3);
                if (board[bIdx] === num) return false;
            }
            return true;
        },
        solve(board) {
            let empty = board.indexOf(0);
            if (empty === -1) return true;
            let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
            for (let n of nums) {
                if (this.isValid(board, empty, n)) {
                    board[empty] = n;
                    if (this.solve(board)) return true;
                    board[empty] = 0;
                }
            }
            return false;
        }
    };

    // --- UI Rendering ---
    function initGrid() {
        const grid = document.getElementById('sudoku-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => selectCell(i);
            grid.appendChild(cell);
        }
    }

    function render() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach((cell, i) => {
            cell.className = 'cell';
            if (state.initial[i] !== 0) cell.classList.add('is-fixed');
            if (state.selected === i) cell.classList.add('selected');
            
            // Related Highlighting
            if (state.selected !== null) {
                let r = Math.floor(i/9), c = i%9, sr = Math.floor(state.selected/9), sc = state.selected%9;
                if (r === sr || c === sc) cell.classList.add('related');
                if (state.board[i] !== 0 && state.board[i] === state.board[state.selected]) cell.classList.add('same-val');
            }

            if (state.board[i] !== 0) {
                cell.innerText = state.board[i];
                if (state.settings.showErrors && state.board[i] !== state.solution[i]) cell.classList.add('err');
            } else {
                cell.innerHTML = renderNotes(state.notes[i]);
            }
        });
    }

    function renderNotes(notes) {
        if (!notes.length) return '';
        let html = '<div class="notes-grid">';
        for (let i = 1; i <= 9; i++) {
            html += `<div class="note-digit">${notes.includes(i) ? i : ''}</div>`;
        }
        return html + '</div>';
    }

    // --- Input Handlers ---
    function handleInput(num) {
        if (state.selected === null || state.initial[state.selected] !== 0) return;
        
        saveHistory();

        if (state.noteMode && num !== 0) {
            let n = state.notes[state.selected];
            state.notes[state.selected] = n.includes(num) ? n.filter(x => x !== num) : [...n, num].sort();
        } else {
            state.board[state.selected] = num;
            if (num !== 0) {
                clearAutoNotes(state.selected, num);
                if (state.settings.vibration) navigator.vibrate?.(20);
            }
        }
        
        render();
        saveToLocal();
        checkWin();
    }

    function clearAutoNotes(idx, num) {
        // 专 专砖转: 拽 注专转  砖专/注/拽
        const r = Math.floor(idx/9), c = idx%9;
        const bR = Math.floor(r/3)*3, bC = Math.floor(c/3)*3;
        for(let i=0; i<9; i++) {
            state.notes[r*9+i] = state.notes[r*9+i].filter(x => x !== num);
            state.notes[i*9+c] = state.notes[i*9+c].filter(x => x !== num);
            let bIdx = (bR + Math.floor(i/3))*9 + (bC + i%3);
            state.notes[bIdx] = state.notes[bIdx].filter(x => x !== num);
        }
    }

    // --- Persistence ---
    function saveToLocal() {
        localStorage.setItem('sudoku_pro_state', JSON.stringify(state));
    }

    function startNewGame(lvl) {
        state.level = lvl;
        document.getElementById('start-modal').style.display = 'none';
        
        let b = Array(81).fill(0);
        Solver.solve(b);
        state.solution = [...b];
        
        let removed = lvl === 'easy' ? 30 : lvl === 'medium' ? 45 : 55;
        while(removed > 0) {
            let i = Math.floor(Math.random()*81);
            if(b[i] !== 0) { b[i] = 0; removed--; }
        }
        
        state.board = [...b];
        state.initial = [...b];
        state.notes = Array.from({length: 81}, () => []);
        state.time = 0;
        state.history = [];
        
        initGrid();
        render();
        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            state.time++;
            let m = Math.floor(state.time/60).toString().padStart(2,'0');
            let s = (state.time%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function selectCell(i) {
        state.selected = i;
        render();
    }

    function toggleNoteMode() {
        state.noteMode = !state.noteMode;
        document.getElementById('note-toggle').classList.toggle('active', state.noteMode);
    }

    function undo() {
        if (state.history.length > 0) {
            let prev = JSON.parse(state.history.pop());
            state.board = prev.board;
            state.notes = prev.notes;
            render();
        }
    }

    function saveHistory() {
        state.history.push(JSON.stringify({board: [...state.board], notes: JSON.parse(JSON.stringify(state.notes))}));
        if(state.history.length > 50) state.history.shift();
    }

    function getHint() {
        if(state.selected === null) return;
        saveHistory();
        state.board[state.selected] = state.solution[state.selected];
        state.notes[state.selected] = [];
        render();
    }

    function eraseCell() {
        if(state.selected !== null && state.initial[state.selected] === 0) {
            saveHistory();
            state.board[state.selected] = 0;
            state.notes[state.selected] = [];
            render();
        }
    }

    function resumeGame() {
        const saved = localStorage.getItem('sudoku_pro_state');
        if(saved) {
            state = JSON.parse(saved);
            document.getElementById('start-modal').style.display = 'none';
            initGrid();
            render();
            startTimer();
        }
    }

    window.onload = () => {
        if(localStorage.getItem('sudoku_pro_state')) {
            document.getElementById('resume-box').style.display = 'block';
        }
    };

    function checkWin() {
        if(state.board.every((v, i) => v === state.solution[i])) {
            clearInterval(timerInterval);
            alert(" ! 爪转!");
            // 注 住住拽转 
        }
    }
</script>
</body>
</html>
