<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Sudoku - 专住 2.2.0</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root {
            --primary-bg: #f0f4f8;
            --cube-blue: #4A90E2;
            --cube-purple: #8b5cf6;
            --cube-teal: #2dd4bf;
            --error: #ef4444;
            --fixed-bg: #e2e8f0;
            --border-thick: 3px solid #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; background: var(--primary-bg);
            display: flex; flex-direction: column; align-items: center;
        }

        .version-bar {
            width: 100%; background: #0f172a; color: white;
            padding: 8px 20px; font-size: 0.8rem; display: flex;
            justify-content: space-between; box-sizing: border-box;
        }

        /* 注爪  */
        #board {
            display: grid;
            grid-template-columns: repeat(9, 45px);
            grid-template-rows: repeat(9, 45px);
            gap: 1px;
            background: #94a3b8;
            border: var(--border-thick);
            margin: 20px auto;
            border-radius: 4px;
        }

        .cell {
            width: 45px; height: 45px; background: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }

        /* 砖转 拽 砖 9 */
        .cell:nth-child(3n) { border-left: var(--border-thick); }
        .cell:nth-child(9n+1) { border-right: none; } /* 转拽 砖 */
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: var(--border-thick); }

        .cell.fixed { background: var(--fixed-bg); color: #475569; cursor: default; }
        .cell.selected { background: var(--cube-blue); color: white; }
        .cell.highlight-same { background: #fef08a; }
        .cell.conflict { background: var(--error) !important; color: white; animation: shake 0.4s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button {
            padding: 10px 20px; border: none; border-radius: 6px;
            background: var(--cube-blue); color: white; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        button:hover { opacity: 0.8; }

        .leaderboard-container { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="version-bar">
    <span>专住 2.2.0 (注专转 住转 转砖转)</span>
    <span id="timer">: 00:00</span>
</div>

<img src="logo.png" style="width: 60px; margin: 20px;">

<div class="controls">
    <button onclick="newGame('easy')">拽</button>
    <button onclick="newGame('medium')"></button>
    <button onclick="newGame('hard')">拽砖</button>
</div>

<div id="board"></div>

<div class="controls">
    <button onclick="undo()">猬锔  </button>
</div>

<div class="leaderboard-container">
    <h3> 注砖专转  - <span id="level-label">拽</span></h3>
    <table id="leaderboard">
        <thead><tr><th>拽</th><th></th><th>转专</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let board = Array(81).fill(0);
    let initial = Array(81).fill(0);
    let history = [];
    let selectedIdx = null;
    let seconds = 0;
    let timerRef;
    let currentLvl = 'easy';

    function createBoardUI() {
        const boardDiv = document.getElementById('board');
        boardDiv.innerHTML = '';
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => selectCell(i);
            boardDiv.appendChild(cell);
        }
    }

    function selectCell(i) {
        selectedIdx = i;
        const val = board[i];
        document.querySelectorAll('.cell').forEach((c, idx) => {
            c.classList.remove('selected', 'highlight-same', 'conflict');
            if (idx === i) c.classList.add('selected');
            if (val !== 0 && board[idx] === val) c.classList.add('highlight-same');
        });
    }

    // 拽转 拽转 转拽转
    function isValid(idx, num) {
        const row = Math.floor(idx / 9);
        const col = idx % 9;
        const blockRow = Math.floor(row / 3) * 3;
        const blockCol = Math.floor(col / 3) * 3;

        for (let i = 0; i < 9; i++) {
            // 拽转 砖专
            if (board[row * 9 + i] === num) return row * 9 + i;
            // 拽转 注
            if (board[i * 9 + col] === num) return i * 9 + col;
            // 拽转 拽 3x3
            let bIdx = (blockRow + Math.floor(i / 3)) * 9 + (blockCol + i % 3);
            if (board[bIdx] === num) return bIdx;
        }
        return -1;
    }

    window.addEventListener('keydown', (e) => {
        if (selectedIdx === null || initial[selectedIdx] !== 0) return;
        const num = parseInt(e.key);
        if (num >= 1 && num <= 9) {
            const conflictIdx = isValid(selectedIdx, num);
            if (conflictIdx !== -1) {
                // 砖转 转砖转
                const cells = document.querySelectorAll('.cell');
                cells[conflictIdx].classList.add('conflict');
                setTimeout(() => cells[conflictIdx].classList.remove('conflict'), 1000);
                return;
            }
            
            history.push([...board]);
            board[selectedIdx] = num;
            saveGame();
            render();
            checkWin();
        } else if (e.key === "Backspace" || e.key === "Delete") {
            board[selectedIdx] = 0;
            render();
        }
    });

    function newGame(lvl) {
        currentLvl = lvl;
        document.getElementById('level-label').innerText = lvl;
        seconds = 0;
        clearInterval(timerRef);
        startTimer();

        // 爪专转  住住 (住专 爪专 , 转 祝 专转 爪专 )
        board = Array(81).fill(0);
        const seeds = [1,2,3,4,5,6,7,8,9];
        let count = lvl === 'easy' ? 35 : lvl === 'medium' ? 25 : 15;
        
        while(count > 0) {
            let pos = Math.floor(Math.random()*81);
            let n = seeds[Math.floor(Math.random()*9)];
            if(board[pos] === 0 && isValid(pos, n) === -1) {
                board[pos] = n;
                count--;
            }
        }

        initial = [...board];
        history = [];
        render();
        updateLeaderboard();
    }

    function render() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => {
            cells[i].innerText = v !== 0 ? v : '';
            cells[i].className = 'cell' + (initial[i] !== 0 ? ' fixed' : '');
            if(i === selectedIdx) cells[i].classList.add('selected');
        });
    }

    function startTimer() {
        timerRef = setInterval(() => {
            seconds++;
            let m = Math.floor(seconds/60).toString().padStart(2,'0');
            let s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `: ${m}:${s}`;
        }, 1000);
    }

    function saveGame() {
        localStorage.setItem('cube_sudoku_save', JSON.stringify({board, initial, seconds, currentLvl}));
    }

    function undo() {
        if (history.length > 0) {
            board = history.pop();
            render();
        }
    }

    function updateLeaderboard() {
        const scores = JSON.parse(localStorage.getItem('scores_'+currentLvl) || '[]');
        document.querySelector('#leaderboard tbody').innerHTML = scores.map((s,i) => 
            `<tr><td>${i+1}</td><td>${s.time}</td><td>${s.date}</td></tr>`).join('');
    }

    function checkWin() {
        if (!board.includes(0)) {
            clearInterval(timerRef);
            alert("爪!");
            let scores = JSON.parse(localStorage.getItem('scores_'+currentLvl) || '[]');
            scores.push({time: document.getElementById('timer').innerText, date: new Date().toLocaleDateString()});
            scores.sort((a,b) => a.time.localeCompare(b.time));
            localStorage.setItem('scores_'+currentLvl, JSON.stringify(scores.slice(0,10)));
            updateLeaderboard();
        }
    }

    window.onload = () => {
        createBoardUI();
        const saved = localStorage.getItem('cube_sudoku_save');
        if(saved) {
            const data = JSON.parse(saved);
            if(confirm("砖 砖拽 拽?")) {
                board = data.board; initial = data.initial; seconds = data.seconds; currentLvl = data.currentLvl;
                startTimer(); render(); updateLeaderboard();
                return;
            }
        }
        newGame('easy');
    };
</script>
</body>
</html>
