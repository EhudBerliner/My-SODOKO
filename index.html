<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cube Sudoku - ×’×¨×¡×” 2.3.0</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --cube-blue: #4A90E2;
            --cube-purple: #8b5cf6;
            --error: #ef4444;
            --dark: #1e293b;
            --border-thick: 3px solid #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; background: var(--primary-bg);
            display: flex; flex-direction: column; align-items: center;
            touch-action: manipulation;
        }

        .version-bar {
            width: 100%; background: var(--dark); color: white;
            padding: 8px 20px; font-size: 0.8rem; display: flex;
            justify-content: space-between; box-sizing: border-box;
        }

        /* ×¢×™×¦×•×‘ ×”×œ×•×— */
        #board {
            display: grid;
            grid-template-columns: repeat(9, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 1px;
            background: #94a3b8;
            border: var(--border-thick);
            margin: 15px auto;
            border-radius: 4px;
        }

        .cell {
            width: 40px; height: 40px; background: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
        }

        /* ×”×“×’×©×ª ×‘×œ×•×§×™× 3x3 */
        .cell:nth-child(3n) { border-left: 2px solid var(--dark); }
        .cell:nth-child(9n+1) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--dark); }

        .cell.fixed { background: #e2e8f0; color: #475569; }
        .cell.selected { background: var(--cube-blue) !important; color: white; }
        .cell.highlight-same { background: #fef08a; }
        .cell.conflict { background: var(--error) !important; color: white; animation: shake 0.4s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* ×œ×•×— ××¡×¤×¨×™× ×ª×—×ª×•×Ÿ (Numpad) */
        .numpad {
            display: grid;
            grid-template-columns: repeat(5, 55px);
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #e2e8f0;
            border-radius: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .num-btn {
            width: 55px; height: 55px;
            background: white; border: none; border-radius: 10px;
            font-size: 1.4rem; font-weight: bold; color: var(--dark);
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 3px 0 #cbd5e1;
            transition: 0.1s;
        }

        .num-btn:active { transform: translateY(2px); box-shadow: none; }
        .num-btn.eraser { background: #fee2e2; color: #b91c1c; font-size: 1.1rem; }

        .controls { display: flex; gap: 8px; margin-top: 5px; }
        button.action-btn {
            padding: 8px 15px; border-radius: 6px; border: none;
            background: var(--dark); color: white; cursor: pointer;
        }

        .leaderboard-container { margin-top: 20px; width: 360px; font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="version-bar">
    <span id="level-display">×¨××”: ×§×œ | 2.3.0</span>
    <span id="timer">00:00</span>
</div>

<div id="board"></div>

<div class="numpad">
    <button class="num-btn" onclick="inputNumber(1)">1</button>
    <button class="num-btn" onclick="inputNumber(2)">2</button>
    <button class="num-btn" onclick="inputNumber(3)">3</button>
    <button class="num-btn" onclick="inputNumber(4)">4</button>
    <button class="num-btn" onclick="inputNumber(5)">5</button>
    <button class="num-btn" onclick="inputNumber(6)">6</button>
    <button class="num-btn" onclick="inputNumber(7)">7</button>
    <button class="num-btn" onclick="inputNumber(8)">8</button>
    <button class="num-btn" onclick="inputNumber(9)">9</button>
    <button class="num-btn eraser" onclick="inputNumber(0)">ğŸ—‘ï¸</button>
</div>

<div class="controls">
    <button class="action-btn" onclick="newGame('easy')">×§×œ</button>
    <button class="action-btn" onclick="newGame('medium')">×‘×™× ×•× ×™</button>
    <button class="action-btn" onclick="newGame('hard')">×§×©×”</button>
    <button class="action-btn" onclick="undo()" style="background:var(--cube-purple)">â†©ï¸ ×‘×˜×œ</button>
</div>

<div class="leaderboard-container">
    <table id="leaderboard">
        <thead><tr><th>××§×•×</th><th>×–××Ÿ</th><th>×ª××¨×™×š</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let board = Array(81).fill(0);
    let initial = Array(81).fill(0);
    let history = [];
    let selectedIdx = null;
    let seconds = 0;
    let timerRef;
    let currentLvl = 'easy';

    function createBoardUI() {
        const boardDiv = document.getElementById('board');
        boardDiv.innerHTML = '';
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.idx = i;
            cell.onclick = () => selectCell(i);
            boardDiv.appendChild(cell);
        }
    }

    function selectCell(i) {
        selectedIdx = i;
        const val = board[i];
        document.querySelectorAll('.cell').forEach((c, idx) => {
            c.classList.remove('selected', 'highlight-same', 'conflict');
            if (idx === i) c.classList.add('selected');
            if (val !== 0 && board[idx] === val) c.classList.add('highlight-same');
        });
    }

    // ×¤×•× ×§×¦×™×™×ª ×”×–× ×ª ××¡×¤×¨ (×××§×œ×“×ª ××• ××”-Numpad)
    function inputNumber(num) {
        if (selectedIdx === null || initial[selectedIdx] !== 0) return;

        if (num === 0) { // ××—×§
            board[selectedIdx] = 0;
            render();
            return;
        }

        const conflictIdx = checkConflict(selectedIdx, num);
        if (conflictIdx !== -1) {
            const cells = document.querySelectorAll('.cell');
            cells[conflictIdx].classList.add('conflict');
            setTimeout(() => cells[conflictIdx].classList.remove('conflict'), 800);
            return;
        }

        history.push([...board]);
        board[selectedIdx] = num;
        saveGame();
        render();
        checkWin();
    }

    function checkConflict(idx, num) {
        const row = Math.floor(idx / 9);
        const col = idx % 9;
        const bR = Math.floor(row / 3) * 3;
        const bC = Math.floor(col / 3) * 3;

        for (let i = 0; i < 9; i++) {
            if (board[row * 9 + i] === num) return row * 9 + i;
            if (board[i * 9 + col] === num) return i * 9 + col;
            let bIdx = (bR + Math.floor(i / 3)) * 9 + (bC + i % 3);
            if (board[bIdx] === num) return bIdx;
        }
        return -1;
    }

    window.addEventListener('keydown', (e) => {
        const n = parseInt(e.key);
        if (n >= 0 && n <= 9) inputNumber(n);
        if (e.key === "Backspace") inputNumber(0);
    });

    function newGame(lvl) {
        currentLvl = lvl;
        document.getElementById('level-display').innerText = `×¨××”: ${lvl} | 2.3.0`;
        seconds = 0;
        clearInterval(timerRef);
        startTimer();

        // ×™×™×¦×•×¨ ×œ×•×— (×“×•×’××” ×‘×¡×™×¡×™×ª)
        board = Array(81).fill(0);
        let count = lvl === 'easy' ? 35 : lvl === 'medium' ? 26 : 18;
        while(count > 0) {
            let p = Math.floor(Math.random()*81);
            let n = Math.floor(Math.random()*9)+1;
            if(board[p] === 0 && checkConflict(p, n) === -1) {
                board[p] = n;
                count--;
            }
        }
        initial = [...board];
        history = [];
        render();
        updateLeaderboard();
    }

    function render() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => {
            cells[i].innerText = v !== 0 ? v : '';
            cells[i].className = 'cell' + (initial[i] !== 0 ? ' fixed' : '');
            if(i === selectedIdx) cells[i].classList.add('selected');
        });
    }

    function startTimer() {
        timerRef = setInterval(() => {
            seconds++;
            let m = Math.floor(seconds/60).toString().padStart(2,'0');
            let s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function undo() {
        if (history.length > 0) {
            board = history.pop();
            render();
        }
    }

    function saveGame() {
        localStorage.setItem('cube_sudoku_save', JSON.stringify({board, initial, seconds, currentLvl}));
    }

    function updateLeaderboard() {
        const scores = JSON.parse(localStorage.getItem('scores_'+currentLvl) || '[]');
        document.querySelector('#leaderboard tbody').innerHTML = scores.map((s,i) => 
            `<tr><td>${i+1}</td><td>${s.time}</td><td>${s.date}</td></tr>`).join('');
    }

    function checkWin() {
        if (!board.includes(0)) {
            clearInterval(timerRef);
            alert("× ×™×¦×—×•×Ÿ ××•×—×œ×˜!");
            let scores = JSON.parse(localStorage.getItem('scores_'+currentLvl) || '[]');
            scores.push({time: document.getElementById('timer').innerText, date: new Date().toLocaleDateString()});
            scores.sort((a,b) => a.time.localeCompare(b.time));
            localStorage.setItem('scores_'+currentLvl, JSON.stringify(scores.slice(0,10)));
            updateLeaderboard();
        }
    }

    window.onload = () => {
        createBoardUI();
        const saved = localStorage.getItem('cube_sudoku_save');
        if(saved && confirm("×œ×”××©×™×š ××©×—×§ ×§×•×“×?")) {
            const data = JSON.parse(saved);
            board = data.board; initial = data.initial; seconds = data.seconds; currentLvl = data.currentLvl;
            startTimer(); render(); updateLeaderboard();
        } else {
            newGame('easy');
        }
    };
</script>
</body>
</html>
