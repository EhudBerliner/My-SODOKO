<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cube Sudoku Pro - V3.1 Retro Look</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root {
            /* Light Mode Palette - Based on V2.3.0 look */
            --bg: #f0f4f8;
            --surface: #ffffff;
            --text: #0f172a;
            --primary: #4A90E2;
            --accent: #8b5cf6;
            
            /* Retro Board Colors */
            --grid-gap-color: #94a3b8; /* The color of thin lines */
            --grid-bold-color: #1e293b; /* The color of thick lines */
            --border-thick: 3px solid var(--grid-bold-color);
            
            --selected: #dbeafe;
            --related: #f1f5f9;
            --same-num: #fef08a;
            --error: #ef4444;
            --fixed: #475569;
            --note: #64748b;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --grid-gap-color: #334155;
            --grid-bold-color: #0f172a;
            --selected: #1e40af;
            --related: #1e293b;
            --same-num: #854d0e;
            --fixed: #94a3b8;
            --note: #cbd5e1;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; /* overflow: hidden; removed to allow scrolling on small screens if needed */
            user-select: none;
            touch-action: manipulation;
        }

        /* New Header Layout */
        .game-header {
            width: 95vw; max-width: 450px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0;
        }
        .header-left, .header-right { display: flex; gap: 10px; font-size: 1.2rem; cursor: pointer; }
        
        /* Timer Centered Above Board */
        .timer-container {
            text-align: center;
            margin-bottom: 5px;
        }
        .timer-box {
            font-variant-numeric: tabular-nums;
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary);
            background: var(--surface);
            padding: 5px 15px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #difficulty-label { font-size: 0.8rem; color: var(--fixed); margin-top: 2px;}

        /* The Grid - V2.3.0 Retro Style */
        #sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            width: 95vw; max-width: 450px; aspect-ratio: 1/1;
            /* Use gap for thin lines */
            background: var(--grid-gap-color);
            gap: 1px;
            /* Thick outer border */
            border: var(--border-thick);
            margin: 0 auto 15px auto;
            border-radius: 4px;
        }

        .cell {
            background: var(--surface); display: flex; align-items: center;
            justify-content: center; position: relative; cursor: pointer;
            font-size: 1.5rem; font-weight: bold; transition: background 0.1s;
        }

        /* 3x3 Block Borders - Retro Style */
        .cell:nth-child(3n) { border-right: 2px solid var(--grid-bold-color); }
        .cell:nth-child(9n) { border-right: none; } /* Fix right edge */
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid-bold-color); }

        /* Cell States */
        .cell.selected { background: var(--selected) !important; }
        .cell.related { background: var(--related); }
        .cell.same-val { background: var(--same-num); }
        .cell.err { color: var(--error) !important; background: #fee2e2 !important; }
        [data-theme="dark"] .cell.err { background: #7f1d1d !important; }
        .cell.is-fixed { color: var(--fixed); }

        /* Notes Grid */
        .notes-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            width: 100%; height: 100%; pointer-events: none;
        }
        .note-digit {
            font-size: 0.6rem; color: var(--note); font-weight: normal;
            display: flex; align-items: center; justify-content: center;
        }

        /* Numpad - Moved below board */
        .numpad {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 8px; width: 95vw; max-width: 450px;
            margin-bottom: 15px;
        }
        .num-btn {
            background: var(--surface); border: none; border-radius: 8px;
            height: 50px; font-size: 1.4rem; font-weight: bold;
            color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--grid-gap-color);
        }
        .num-btn:active { transform: scale(0.95); background: var(--primary); color: white; }

        /* Toolbar - Moved below Numpad */
        .toolbar {
            display: flex; gap: 10px; width: 95vw; max-width: 450px;
            justify-content: space-between; margin-bottom: 20px;
        }
        .tool-btn { 
            background: var(--surface); border: 1px solid var(--grid-gap-color);
            padding: 10px 5px; border-radius: 8px; cursor: pointer; color: var(--text);
            display: flex; flex-direction: column; align-items: center; font-size: 0.75rem;
            flex: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tool-btn span { font-size: 1.2rem; margin-bottom: 4px; }
        .tool-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Modals */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: var(--surface); padding: 30px; border-radius: 20px;
            width: 80%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-btn-group { display: grid; gap: 10px; margin-top: 20px; }
        .modal-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; background: var(--primary); color: white; }
        .modal-btn.secondary { background: var(--grid-gap-color); color: var(--text); }

        @media (max-height: 700px) {
             /* Adjustments for smaller screens */
            #sudoku-grid { height: auto; aspect-ratio: auto; }
            .cell { height: 40px; font-size: 1.3rem; }
            .num-btn { height: 45px; }
        }
    </style>
</head>
<body data-theme="light">

<div class="game-header">
    <div class="header-left">
        <span onclick="toggleSettings()">锔</span>
    </div>
    <div class="header-right">
        <span onclick="toggleStats()"></span>
    </div>
</div>

<div class="timer-container">
    <div class="timer-box" id="timer">00:00</div>
    <div id="difficulty-label">MEDIUM</div>
</div>

<div id="sudoku-grid"></div>

<div class="numpad">
    <button class="num-btn" onclick="handleInput(1)">1</button>
    <button class="num-btn" onclick="handleInput(2)">2</button>
    <button class="num-btn" onclick="handleInput(3)">3</button>
    <button class="num-btn" onclick="handleInput(4)">4</button>
    <button class="num-btn" onclick="handleInput(5)">5</button>
    <button class="num-btn" onclick="handleInput(6)">6</button>
    <button class="num-btn" onclick="handleInput(7)">7</button>
    <button class="num-btn" onclick="handleInput(8)">8</button>
    <button class="num-btn" onclick="handleInput(9)">9</button>
    <button class="num-btn" onclick="handleInput(0)" style="color: var(--error);">锔</button>
</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()"><span>╋</span>Undo</button>
    <button class="tool-btn" id="note-toggle" onclick="toggleNoteMode()"><span>锔</span>Notes</button>
    <button class="tool-btn" onclick="getHint()"><span></span>Hint</button>
    <button class="tool-btn" onclick="eraseCell()"><span>Ч</span>Erase</button>
</div>

<div id="start-modal" class="modal" style="display: flex;">
    <div class="modal-content">
        <img src="logo.png" style="width:80px; margin-bottom:15px;" alt="Logo">
        <h2>Cube Sudoku Pro</h2>
        <div id="resume-box" style="display:none; margin-bottom: 15px;">
            <button class="modal-btn" style="background: var(--accent); width: 100%;" onclick="resumeGame()">砖 砖拽 专</button>
        </div>
        <p>砖拽 砖:</p>
        <div class="modal-btn-group">
            <button class="modal-btn" onclick="startNewGame('easy')">拽</button>
            <button class="modal-btn" onclick="startNewGame('medium')"></button>
            <button class="modal-btn" onclick="startNewGame('hard')">拽砖</button>
        </div>
    </div>
</div>

<script>
    // --- 拽转 砖拽 ( 砖 专住 V3.0) ---
    let state = {
        board: Array(81).fill(0), initial: Array(81).fill(0), notes: Array.from({length: 81}, () => []),
        solution: [], history: [], selected: null, noteMode: false, time: 0, level: 'medium',
        settings: { vibration: true, theme: 'light', showErrors: true }
    };
    let timerInterval;

    const Solver = {
        isValid(board, idx, num) {
            const r = Math.floor(idx / 9), c = idx % 9;
            const bR = Math.floor(r / 3) * 3, bC = Math.floor(c / 3) * 3;
            for (let i = 0; i < 9; i++) {
                if (board[r * 9 + i] === num || board[i * 9 + c] === num) return false;
                let bIdx = (bR + Math.floor(i / 3)) * 9 + (bC + i % 3);
                if (board[bIdx] === num) return false;
            }
            return true;
        },
        solve(board) {
            let empty = board.indexOf(0);
            if (empty === -1) return true;
            let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
            for (let n of nums) {
                if (this.isValid(board, empty, n)) {
                    board[empty] = n;
                    if (this.solve(board)) return true;
                    board[empty] = 0;
                }
            }
            return false;
        }
    };

    function initGrid() {
        const grid = document.getElementById('sudoku-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => selectCell(i);
            grid.appendChild(cell);
        }
    }

    function render() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach((cell, i) => {
            cell.className = 'cell';
            if (state.initial[i] !== 0) cell.classList.add('is-fixed');
            if (state.selected === i) cell.classList.add('selected');
            
            if (state.selected !== null) {
                let r = Math.floor(i/9), c = i%9, sr = Math.floor(state.selected/9), sc = state.selected%9;
                if (r === sr || c === sc) cell.classList.add('related');
                if (state.board[i] !== 0 && state.board[i] === state.board[state.selected]) cell.classList.add('same-val');
            }

            if (state.board[i] !== 0) {
                cell.innerText = state.board[i];
                if (state.settings.showErrors && state.board[i] !== state.solution[i]) cell.classList.add('err');
            } else {
                cell.innerHTML = renderNotes(state.notes[i]);
            }
        });
        document.getElementById('difficulty-label').innerText = state.level.toUpperCase();
    }

    function renderNotes(notes) {
        if (!notes.length) return '';
        let html = '<div class="notes-grid">';
        for (let i = 1; i <= 9; i++) {
            html += `<div class="note-digit">${notes.includes(i) ? i : ''}</div>`;
        }
        return html + '</div>';
    }

    function handleInput(num) {
        if (state.selected === null || state.initial[state.selected] !== 0) return;
        saveHistory();
        if (state.noteMode && num !== 0) {
            let n = state.notes[state.selected];
            state.notes[state.selected] = n.includes(num) ? n.filter(x => x !== num) : [...n, num].sort();
        } else {
            state.board[state.selected] = num;
            if (num !== 0) {
                clearAutoNotes(state.selected, num);
                if (state.settings.vibration) navigator.vibrate?.(20);
            }
        }
        render(); saveToLocal(); checkWin();
    }

    function clearAutoNotes(idx, num) {
        const r = Math.floor(idx/9), c = idx%9;
        const bR = Math.floor(r/3)*3, bC = Math.floor(c/3)*3;
        for(let i=0; i<9; i++) {
            state.notes[r*9+i] = state.notes[r*9+i].filter(x => x !== num);
            state.notes[i*9+c] = state.notes[i*9+c].filter(x => x !== num);
            let bIdx = (bR + Math.floor(i/3))*9 + (bC + i%3);
            state.notes[bIdx] = state.notes[bIdx].filter(x => x !== num);
        }
    }

    function saveToLocal() { localStorage.setItem('sudoku_pro_v3_state', JSON.stringify(state)); }

    function startNewGame(lvl) {
        state.level = lvl;
        document.getElementById('start-modal').style.display = 'none';
        let b = Array(81).fill(0); Solver.solve(b); state.solution = [...b];
        let removed = lvl === 'easy' ? 30 : lvl === 'medium' ? 45 : 55;
        while(removed > 0) { let i = Math.floor(Math.random()*81); if(b[i] !== 0) { b[i] = 0; removed--; }}
        state.board = [...b]; state.initial = [...b]; state.notes = Array.from({length: 81}, () => []);
        state.time = 0; state.history = [];
        initGrid(); render(); startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            state.time++;
            let m = Math.floor(state.time/60).toString().padStart(2,'0');
            let s = (state.time%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function selectCell(i) { state.selected = i; render(); }
    function toggleNoteMode() { state.noteMode = !state.noteMode; document.getElementById('note-toggle').classList.toggle('active', state.noteMode); }
    function undo() { if (state.history.length > 0) { let prev = JSON.parse(state.history.pop()); state.board = prev.board; state.notes = prev.notes; render(); saveToLocal();}}
    function saveHistory() { state.history.push(JSON.stringify({board: [...state.board], notes: JSON.parse(JSON.stringify(state.notes))})); if(state.history.length > 50) state.history.shift(); }
    function getHint() { if(state.selected === null || state.initial[state.selected] !== 0) return; saveHistory(); state.board[state.selected] = state.solution[state.selected]; state.notes[state.selected] = []; render(); saveToLocal(); checkWin(); }
    function eraseCell() { handleInput(0); }

    function resumeGame() {
        const saved = localStorage.getItem('sudoku_pro_v3_state');
        if(saved) { state = JSON.parse(saved); document.getElementById('start-modal').style.display = 'none'; initGrid(); render(); startTimer(); }
    }

    function toggleSettings() {
        state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', state.settings.theme);
        saveToLocal();
    }
    function toggleStats() { alert("住住拽转 转住驻 注 !"); }

    window.onload = () => {
        if(localStorage.getItem('sudoku_pro_v3_state')) { document.getElementById('resume-box').style.display = 'block'; }
        document.body.setAttribute('data-theme', state.settings.theme);
    };

    function checkWin() {
        if(state.board.every((v, i) => v === state.solution[i])) {
            clearInterval(timerInterval); setTimeout(() => alert(` ! 住转 -${document.getElementById('timer').innerText}`), 100);
            localStorage.removeItem('sudoku_pro_v3_state');
        }
    }
</script>
</body>
</html>
